<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Scratch - The Gentlemen's Wager</title>
    
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" type="image/png" href="./images/logo192.png" />
    <link rel="apple-touch-icon" href="./images/logo192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#00594C">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #00594C; --accent: #E8D55A; --bg-body: #F3F4F6; --bg-card: #FFFFFF;
            --text-main: #111827; --text-sub: #6B7280; --border: #E5E7EB;
            --font-serif: "Times New Roman", Times, serif; 
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body.dark-mode { --primary: #059669; --bg-body: #111827; --bg-card: #1F2937; --text-main: #F9FAFB; --text-sub: #9CA3AF; --border: #374151; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-sans); transition: background 0.3s; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--bg-card); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* HEADER */
        .header { background-color: var(--primary); padding: 0 20px; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; height: 60px; }
        .brand h1 { font-family: var(--font-serif); font-size: 22px; font-weight: 700; letter-spacing: 0.5px; margin: 0; }
        
        /* TABS */
        .nav-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .nav-item { flex: 1; text-align: center; padding: 16px; color: var(--text-sub); font-weight: 600; cursor: pointer; font-size: 14px; position: relative; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }

        /* CONTENT */
        .content { flex: 1; padding-bottom: 100px; overflow-y: auto; }
        
        /* HERO GRID */
        .hero-grid { display: flex; gap: 16px; padding: 20px; border-bottom: 1px solid var(--border); background: var(--bg-body); }
        .hero-box { 
            flex: 1; height: 140px; 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; 
            padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); text-align: center;
        }
        .box-label { font-size: 11px; fontWeight: 800; color: var(--text-sub); text-transform: uppercase; margin-bottom: 16px; letter-spacing: 0.5px; }
        .box-val { font-family: var(--font-serif); font-size: 32px; font-weight: 700; line-height: 1; }
        
        /* PLUS BUTTON */
        .plus-btn { 
            width: 48px; height: 48px; border-radius: 50%; background: var(--primary); color: white; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 10px rgba(0,89,76,0.3); transition: transform 0.1s; cursor: pointer;
        }
        .plus-btn:active { transform: scale(0.95); }

        .text-green { color: #059669; } .text-red { color: #DC2626; }
        
        /* LISTS */
        .feed-list { padding: 16px; }
        .bet-row { display: flex; align-items: center; padding: 16px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; background: var(--bg-card); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .bet-icon { width: 42px; height: 42px; padding: 8px; background: var(--bg-body); border-radius: 10px; margin-right: 14px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .bet-icon img { width: 100%; height: 100%; object-fit: contain; }
        .bet-info { flex: 1; }
        .bet-val { font-family: var(--font-serif); font-size: 18px; font-weight: 700; }

        /* SETTINGS & ROSTER */
        .settings-view { padding: 24px; }
        .settings-card { background: var(--bg-body); border-radius: 12px; border: 1px solid var(--border); padding: 16px; margin-bottom: 24px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .roster-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .roster-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 2px solid var(--border); }
        .delete-btn { color: #DC2626; font-size: 18px; cursor: pointer; padding: 8px; margin-left: auto; }
        .add-row { display: flex; gap: 8px; margin-top: 12px; }
        
        .input-std { padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); font-size: 16px; -webkit-appearance: none; flex: 1; }
        .input-lg { font-size: 20px; padding: 16px; text-align: center; border: 2px solid var(--border); }
        .input-lg:focus { border-color: var(--primary); outline: none; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-bottom { align-items: flex-end; }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 450px; border-radius: 24px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-bottom .modal-content { border-bottom-left-radius: 0; border-bottom-right-radius: 0; width: 100%; max-width: 500px; }
        
        .section-label { font-size: 11px; font-weight: 800; color: var(--text-sub); margin-bottom: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .chip-grid { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .chip { padding: 10px 16px; border: 1px solid var(--border); background: var(--bg-card); border-radius: 50px; font-weight: 600; color: var(--text-main); font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .chip.active-red { background: #DC2626; color: white; border-color: #DC2626; } 
        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 32px; }
        .type-card { border: 1px solid var(--border); padding: 16px; border-radius: 12px; text-align: center; background: var(--bg-card); cursor: pointer; position: relative; }
        .type-card.active { border-color: var(--primary); background: rgba(0, 89, 76, 0.05); box-shadow: 0 0 0 2px var(--primary); }
        .type-img { width: 40px; height: 40px; margin-bottom: 8px; object-fit: contain; opacity: 0.7; }
        .type-card.active .type-img { opacity: 1; }

        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; text-align: center; border: none; transition: opacity 0.2s; }
        .btn-full:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }

        /* UTILS */
        .login-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; text-align: center; padding: 20px; padding-top: 80px; }
        .loading-tip { font-size: 12px; opacity: 0.6; margin-top: 20px; color: #DC2626; display: none; }
        .icon-btn { cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.1s; }
        .icon-btn:active { background: rgba(255,255,255,0.1); }
        
        /* SLIDER */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--primary); margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, getDocs, getDoc, setDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
     // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBPBps7eOq5gqyT5LuOnUGJkhPumBbZh-w",
  authDomain: "scratch-d0420.firebaseapp.com",
  projectId: "scratch-d0420",
  storageBucket: "scratch-d0420.firebasestorage.app",
  messagingSenderId: "780358513887",
  appId: "1:780358513887:web:64d2cd2ab8350fb4cda56a"
};

// Initialize Firebase

        const firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(firebaseApp);
        window.auth = getAuth(firebaseApp);
        window.provider = new GoogleAuthProvider();
        window.ops = { collection, addDoc, doc, updateDoc, getDocs, getDoc, setDoc, query, where, orderBy, onSnapshot, serverTimestamp, signInWithPopup, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        let setGlobalAlert = null;
        const showAppAlert = (title, msg) => {
            if(setGlobalAlert) setGlobalAlert({ show: true, title, msg });
            else alert(msg);
        };

        function App() {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState(null);
            const [loading, setLoading] = useState(true);
            const [roster, setRoster] = useState([]); 
            const [alertState, setAlertState] = useState({ show: false, title: '', msg: '' });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isStandalone, setIsStandalone] = useState(false);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('theme') === 'dark');

            // --- THEME & INSTALL ---
            useEffect(() => {
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            useEffect(() => {
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    setIsStandalone(true);
                }
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                });
            }, []);

            // --- AUTH ---
            useEffect(() => {
                setGlobalAlert = setAlertState; 
                const timer = setTimeout(() => {
                    const tip = document.getElementById('loading-tip');
                    if(tip) tip.style.display = 'block';
                }, 4000);

                if (!window.ops) return;
                const unsubscribe = window.ops.onAuthStateChanged(window.auth, async (u) => {
                    if (u) {
                        try {
                            const userRef = window.ops.doc(window.db, "users", u.uid);
                            const docSnap = await window.ops.getDoc(userRef);
                            
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.username) {
                                    setUsername(data.username);
                                    if(data.roster) setRoster(data.roster);
                                }
                                await window.ops.updateDoc(userRef, { photoURL: u.photoURL });
                            } else {
                                await window.ops.setDoc(userRef, { 
                                    email: u.email, 
                                    displayName: u.displayName,
                                    photoURL: u.photoURL 
                                }, { merge: true });
                            }
                        } catch (e) { console.log("Error", e); }
                    }
                    setUser(u);
                    setLoading(false);
                    clearTimeout(timer);
                });
                return () => { unsubscribe(); clearTimeout(timer); }
            }, []);

            const handleLogin = async () => {
                try { await window.ops.signInWithPopup(window.auth, window.provider); } catch (e) { showAppAlert("Login Error", e.message); }
            };

            const handleInstall = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((result) => {
                        if (result.outcome === 'accepted') setDeferredPrompt(null);
                    });
                } else {
                    showAppAlert("Install", "To install: Tap the Share/Menu button in your browser, then 'Add to Home Screen'.");
                }
            };

            const [isSavingUser, setIsSavingUser] = useState(false);
            const handleSetUsername = async (newUsername) => {
                if(isSavingUser) return; 
                const cleanName = newUsername.trim().toLowerCase().replace(/\s+/g, '');
                if (cleanName.length < 3) return showAppAlert("Invalid", "Username must be at least 3 characters.");
                setIsSavingUser(true); 
                try {
                    const q = window.ops.query(window.ops.collection(window.db, "users"), window.ops.where("username", "==", cleanName));
                    const snap = await window.ops.getDocs(q);
                    if (!snap.empty) { setIsSavingUser(false); return showAppAlert("Taken", "That username is already taken. Try another."); }
                    const userRef = window.ops.doc(window.db, "users", user.uid);
                    await window.ops.setDoc(userRef, { username: cleanName }, { merge: true });
                    setUsername(cleanName); 
                } catch(e) { setIsSavingUser(false); showAppAlert("Error", "Could not save."); }
            };

            // --- BIDIRECTIONAL FRIEND ADDING ---
            const addFriend = async (friendUsername) => {
                const cleanName = friendUsername.trim().toLowerCase().replace('@', '');
                
                try {
                    // 1. Find Friend
                    const q = window.ops.query(window.ops.collection(window.db, "users"), window.ops.where("username", "==", cleanName));
                    const snap = await window.ops.getDocs(q);
                    
                    if (snap.empty) return showAppAlert("Not Found", "User @" + cleanName + " not found.");
                    const friendDoc = snap.docs[0];
                    const friendData = friendDoc.data();
                    
                    if(friendData.email === user.email) return showAppAlert("Error", "You can't add yourself!");
                    
                    // 2. Add Friend to MY roster
                    const newFriendForMe = { 
                        name: friendData.displayName || cleanName, 
                        email: friendData.email, 
                        username: cleanName,
                        photoURL: friendData.photoURL
                    };
                    
                    if(roster.some(r => r.username === cleanName)) return showAppAlert("Exists", "User already in your clubhouse.");
                    
                    const myNewRoster = [...roster, newFriendForMe];
                    setRoster(myNewRoster);
                    
                    const myRef = window.ops.doc(window.db, "users", user.uid);
                    await window.ops.updateDoc(myRef, { roster: myNewRoster });

                    // 3. Add ME to FRIEND'S roster (Bidirectional)
                    const meForFriend = {
                        name: user.displayName || username,
                        email: user.email,
                        username: username,
                        photoURL: user.photoURL
                    };

                    const friendRef = window.ops.doc(window.db, "users", friendDoc.id);
                    const friendSnap = await window.ops.getDoc(friendRef);
                    if(friendSnap.exists()) {
                        const theirRoster = friendSnap.data().roster || [];
                        if(!theirRoster.some(r => r.username === username)) {
                            const theirNewRoster = [...theirRoster, meForFriend];
                            await window.ops.updateDoc(friendRef, { roster: theirNewRoster });
                        }
                    }

                    showAppAlert("Connected!", "You and @" + cleanName + " are now connected.");

                } catch (e) {
                    showAppAlert("Error", "Connection failed: " + e.message);
                }
            };

            const removeFriend = async (friendEmail) => {
                const newRoster = roster.filter(f => f.email !== friendEmail);
                setRoster(newRoster);
                const userRef = window.ops.doc(window.db, "users", user.uid);
                await window.ops.updateDoc(userRef, { roster: newRoster });
            };

            const AlertModal = () => (
                alertState.show ? (
                    <div className="modal-overlay" style={{zIndex:999}}>
                        <div className="modal-content" style={{textAlign:'center', maxWidth:320, borderRadius:20}}>
                            <h3 style={{fontFamily:'Times New Roman', fontSize:22, marginBottom:8, color:'var(--text-main)'}}>{alertState.title}</h3>
                            <p style={{marginBottom:24, color:'var(--text-sub)'}}>{alertState.msg}</p>
                            <button className="btn-full btn-primary" onClick={() => setAlertState({ ...alertState, show: false })}>OK</button>
                        </div>
                    </div>
                ) : null
            );

            if (loading) return <div className="login-screen" style={{justifyContent: 'center', paddingTop: 0}}><div>Loading...</div></div>;

            if (!user) return (
                <div className="login-screen" style={{justifyContent: 'center', paddingTop: 0}}>
                    <img src="./images/logo192.png" style={{width:80, borderRadius:16, marginBottom:20}} onError={(e)=>e.target.style.display='none'}/>
                    <h1 style={{fontFamily:'Times New Roman', fontSize:48}}>Scratch</h1>
                    <p style={{opacity:0.6, letterSpacing:2, fontSize:12, marginBottom:40}}>THE GENTLEMEN'S LEDGER</p>
                    <button className="btn-full" style={{background:'white', color:'var(--primary)', maxWidth:280, boxShadow:'0 10px 30px rgba(0,0,0,0.1)'}} onClick={handleLogin}>Sign in with Google</button>
                    <AlertModal />
                </div>
            );

            if (!username) return (
                <div className="login-screen">
                    <img src="./images/logo192.png" style={{width: 80, borderRadius: 16, marginBottom: 24, boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}} />
                    <div style={{fontFamily: 'Times New Roman', fontWeight: 'bold', fontSize: 26, marginBottom: 40, color: 'var(--text-main)'}}>The Gentlemen's Wager</div>
                    <h3 style={{marginBottom: 8, fontSize: 18}}>Create Username</h3>
                    <p style={{opacity: 0.6, fontSize: 14, marginBottom: 24}}>This is how friends will find you.</p>
                    <input id="usernameInput" className="input-std input-lg" placeholder="e.g. Tiger" style={{maxWidth: 300, width: '100%', marginBottom: 24}} />
                    <button className="btn-full btn-primary" style={{maxWidth: 300}} disabled={isSavingUser} onClick={() => handleSetUsername(document.getElementById('usernameInput').value)}>{isSavingUser ? "Saving..." : "Set Username"}</button>
                    <AlertModal />
                </div>
            );

            return (
                <>
                    <MainApp 
                        user={user} username={username} roster={roster} 
                        onAddFriend={addFriend} onRemoveFriend={removeFriend} 
                        showAppAlert={showAppAlert} 
                        darkMode={darkMode} setDarkMode={setDarkMode}
                        handleInstall={handleInstall}
                        isStandalone={isStandalone}
                    />
                    <AlertModal />
                </>
            );
        }

        // --- MAIN APP COMPONENT ---
        function MainApp({ user, username, roster, onAddFriend, onRemoveFriend, showAppAlert, darkMode, setDarkMode, handleInstall, isStandalone }) {
            // SINGLE SOURCE OF TRUTH FOR VIEW STATE
            const [view, setView] = useState('ledger'); // 'ledger', 'clubhouse', 'settings', 'friend'
            const [lastTab, setLastTab] = useState('ledger'); 
            
            const [activeFriend, setActiveFriend] = useState(null); 
            const [bets, setBets] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);

            // Re-render icons on view change
            useEffect(() => { setTimeout(() => lucide.createIcons(), 50); }, [view, activeFriend, modalOpen]);

            useEffect(() => {
                const q = window.ops.query(
                    window.ops.collection(window.db, "bets"), 
                    window.ops.where("participants", "array-contains", user.email)
                );
                
                return window.ops.onSnapshot(q, (snapshot) => {
                    const allBets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allBets.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setBets(allBets);
                });
            }, [user]);

            const getStats = (betList) => {
                let balance = 0;
                betList.forEach(b => {
                    const numPlayers = b.participants ? b.participants.length : 2;
                    if (b.winnerEmail === user.email) balance += (b.amount * (numPlayers - 1));
                    else balance -= b.amount;
                });
                return balance;
            };

            const stats = useMemo(() => getStats(bets), [bets]);

            const handleAddBet = async (betData) => {
                try {
                    await window.ops.addDoc(window.ops.collection(window.db, "bets"), {
                        ...betData,
                        createdBy: user.uid,
                        createdAt: window.ops.serverTimestamp()
                    });
                    setModalOpen(false);
                } catch (e) { showAppAlert("Error", e.message); }
            };

            const getBetContext = (bet) => {
                const iWon = bet.winnerEmail === user.email;
                if (iWon) {
                    const opponents = bet.participants.filter(e => e !== user.email);
                    if (opponents.length === 1) {
                        const friend = roster.find(r => r.email === opponents[0]);
                        return `vs ${friend ? friend.name : 'Opponent'}`;
                    } else {
                        return `vs ${opponents.length} others`;
                    }
                } else {
                    return `vs ${bet.winnerName || 'Opponent'}`;
                }
            };

            // NAVIGATION LOGIC
            const switchTab = (tab) => {
                setActiveFriend(null);
                setLastTab(tab);
                setView(tab);
            };

            const openSettings = () => {
                setActiveFriend(null); // Clear friend so we don't confuse views
                setView('settings');
            };

            const openFriend = (friend) => {
                setActiveFriend(friend);
                setView('friend');
            };

            const goBack = () => {
                if (view === 'settings') setView(lastTab);
                else if (view === 'friend') {
                    setActiveFriend(null);
                    setView('clubhouse');
                }
            };

            // --- STRICT RENDER FUNCTIONS ---
            
            const renderHeader = () => (
                <header className="header">
                    {view === 'settings' ? (
                        <>
                            <div className="icon-btn" onClick={goBack}><i data-lucide="arrow-left" color="white"></i></div>
                            <div className="brand">Settings</div>
                            <div style={{width:40}}></div>
                        </>
                    ) : view === 'friend' ? (
                        <>
                            <div className="icon-btn" onClick={goBack}><i data-lucide="arrow-left" color="white"></i></div>
                            <div className="brand">{activeFriend ? activeFriend.name : 'Friend'}</div>
                            <div style={{width:40}}></div>
                        </>
                    ) : (
                        <>
                            <div className="brand">Scratch</div>
                            <div className="icon-btn" onClick={openSettings}><i data-lucide="settings" color="white"></i></div>
                        </>
                    )}
                </header>
            );

            // --- PAGE COMPONENTS ---

            const LedgerPage = () => (
                <div className="content">
                    <div className="hero-grid">
                        <div className="hero-box">
                            <div className="box-label">NET BALANCE</div>
                            <div className={`box-val ${stats >= 0 ? 'text-green' : 'text-red'}`}>
                                {stats >= 0 ? '+' : '-'}${Math.abs(stats)}
                            </div>
                        </div>
                        <div className="hero-box" onClick={() => setModalOpen(true)} style={{cursor:'pointer'}}>
                            <div className="box-label">PLACE WAGER</div>
                            <div className="plus-btn"><i data-lucide="plus" size="28"></i></div>
                        </div>
                    </div>
                    
                    <div style={{padding:'24px 20px 10px', fontWeight:700, display:'flex', alignItems:'center', gap:8}}>
                        <i data-lucide="history" size="18"></i> Recent Activity
                    </div>
                    <div className="feed-list">
                        {bets.map(bet => (
                            <div key={bet.id} className="bet-row">
                                <div className="bet-icon">
                                    {bet.img ? <img src={bet.img} onError={(e)=>{e.target.style.display='none'}} /> : <i data-lucide="trophy" color="var(--primary)"></i>}
                                </div>
                                <div className="bet-info">
                                    <div style={{fontWeight:600}}>{bet.type}</div>
                                    <div style={{fontSize:13, color:'var(--text-sub)'}}>
                                        {bet.winnerEmail === user.email ? 'You won' : 'You lost'} <strong>{getBetContext(bet)}</strong>
                                    </div>
                                    {(bet.course || bet.hole) && <div style={{fontSize:11, color:'var(--primary)', marginTop:2, fontWeight:500}}>{bet.hole ? `Hole ${bet.hole}` : ''} {bet.hole && bet.course ? '•' : ''} {bet.course}</div>}
                                </div>
                                <div className={`bet-val ${bet.winnerEmail === user.email ? 'text-green' : 'text-red'}`}>
                                    {bet.winnerEmail === user.email ? '+' : '-'}${bet.amount}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const ClubhousePage = () => (
                <div className="content settings-view">
                    <div className="section-label">MY FRIENDS</div>
                    <div className="settings-card">
                        {roster.length === 0 && <div style={{padding:10, color:'#999', fontSize:13}}>No friends added yet.</div>}
                        {roster.map((friend, i) => (
                            <div key={i} className="roster-item" onClick={() => openFriend(friend)}>
                                <img src={friend.photoURL || './images/logo192.png'} className="roster-avatar" onError={(e) => e.target.style.opacity=0.5} />
                                <div>
                                    <span style={{fontWeight:600, display:'block'}}>{friend.name} <i data-lucide="chevron-right" size="14" style={{opacity:0.3, verticalAlign:'middle'}}></i></span>
                                    <span style={{fontSize:12, color:'var(--primary)'}}>@{friend.username}</span>
                                </div>
                                <div className="delete-btn" onClick={(e) => { e.stopPropagation(); onRemoveFriend(friend.email); }}>×</div>
                            </div>
                        ))}
                        <div className="add-row">
                            <input id="newFriendUser" className="input-std" placeholder="Search Username..." />
                            <button className="btn-primary" style={{borderRadius:8, padding:'0 16px', border:'none', cursor:'pointer'}} onClick={() => {
                                const val = document.getElementById('newFriendUser').value;
                                if(val) { onAddFriend(val); document.getElementById('newFriendUser').value = ''; }
                            }}>Add</button>
                        </div>
                    </div>
                </div>
            );

            const SettingsPage = () => (
                <div className="content settings-view">
                    <div style={{textAlign:'center', marginBottom:30}}>
                        <img src={user.photoURL} style={{width:80, borderRadius:'50%', border:'3px solid var(--primary)'}} />
                        <h2>{user.displayName}</h2>
                        <p style={{fontSize:14, fontWeight:'bold', color:'var(--primary)'}}>@{username}</p>
                    </div>

                    <div className="settings-card">
                        <div className="settings-row">
                            <span style={{fontWeight:600}}>Dark Mode</span>
                            <input type="checkbox" checked={darkMode} onChange={() => setDarkMode(!darkMode)} style={{transform: 'scale(1.5)', accentColor: 'var(--primary)'}} />
                        </div>
                    </div>

                    <div className="settings-card" style={{padding:20}}>
                        <h4 style={{marginBottom:10}}>How to Play</h4>
                        <ol style={{paddingLeft:20, color:'var(--text-sub)', fontSize:14, lineHeight:1.6}}>
                            <li>Add friends in the Clubhouse tab.</li>
                            <li>Tap (+) on My Ledger to place a wager.</li>
                            <li>Select winner, amount, and bet type.</li>
                            <li>Settlements happen on the course.</li>
                        </ol>
                    </div>

                    {!isStandalone && (
                        <button className="btn-full btn-primary" onClick={handleInstall} style={{marginBottom:12}}>Install App</button>
                    )}
                    <button className="btn-full" style={{background:'transparent', border:'1px solid #DC2626', color:'#DC2626'}} onClick={() => window.ops.signOut(window.auth)}>Sign Out</button>
                </div>
            );

            const FriendPage = () => {
                if (!activeFriend) return null;
                const friendBets = bets.filter(b => b.participants && b.participants.includes(activeFriend.email));
                const friendBalance = getStats(friendBets);
                return (
                    <div className="content">
                        <div className="hero-box" style={{height:'auto', border:'none', boxShadow:'none', background:'transparent', marginBottom:0, paddingBottom:0}}>
                            <div style={{marginBottom:16}}>
                                <img src={activeFriend.photoURL || './images/logo192.png'} style={{width:80, height:80, borderRadius:'50%', border:'3px solid var(--primary)', objectFit:'cover'}} />
                                <h2 style={{marginTop:8, fontSize:24}}>{activeFriend.name}</h2>
                                <div style={{fontSize:14, color:'var(--text-sub)', fontWeight:'bold'}}>@{activeFriend.username}</div>
                            </div>
                            <div style={{fontSize:11, fontWeight:800, color:'var(--text-sub)', textTransform:'uppercase'}}>Net vs You</div>
                            <div className={`hero-amount ${friendBalance >= 0 ? 'text-green' : 'text-red'}`}>
                                {friendBalance >= 0 ? '+' : '-'}${Math.abs(friendBalance)}
                            </div>
                        </div>
                        <div style={{padding:'24px 20px 10px', fontWeight:700, display:'flex', alignItems:'center', gap:8}}>
                            <i data-lucide="history" size="18"></i> History vs {activeFriend.name}
                        </div>
                        <div className="feed-list">
                            {friendBets.length === 0 && <div style={{padding:20, color:'#999', textAlign:'center'}}>No bets recorded yet.</div>}
                            {friendBets.map(bet => (
                                <div key={bet.id} className="bet-row">
                                    <div className="bet-icon">
                                        {bet.img ? <img src={bet.img} onError={(e)=>{e.target.style.display='none'}} /> : <i data-lucide="trophy" color="var(--primary)"></i>}
                                    </div>
                                    <div className="bet-info">
                                        <div style={{fontWeight:600}}>{bet.type}</div>
                                        <div style={{fontSize:13, color:'var(--text-sub)'}}>
                                            {bet.winnerEmail === user.email ? 'You won' : `${activeFriend.name} won`}
                                        </div>
                                        {(bet.course || bet.hole) && <div style={{fontSize:11, color:'var(--primary)', marginTop:2, fontWeight:500}}>{bet.hole ? `Hole ${bet.hole}` : ''} {bet.hole && bet.course ? '•' : ''} {bet.course}</div>}
                                    </div>
                                    <div className={`bet-val ${bet.winnerEmail === user.email ? 'text-green' : 'text-red'}`}>
                                        {bet.winnerEmail === user.email ? '+' : '-'}${bet.amount}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- MASTER RENDER ---
            return (
                <div className="app-container">
                    {renderHeader()}
                    
                    {/* Tabs only show on main pages */}
                    {(view === 'ledger' || view === 'clubhouse') && (
                        <div className="nav-tabs">
                            <div className={`nav-item ${view === 'ledger' ? 'active' : ''}`} onClick={() => switchTab('ledger')}>My Ledger</div>
                            <div className={`nav-item ${view === 'clubhouse' ? 'active' : ''}`} onClick={() => switchTab('clubhouse')}>Clubhouse</div>
                        </div>
                    )}

                    {/* Strict View Switching */}
                    {view === 'ledger' && <LedgerPage />}
                    {view === 'clubhouse' && <ClubhousePage />}
                    {view === 'settings' && <SettingsPage />}
                    {view === 'friend' && <FriendPage />}

                    {modalOpen && <BetModal user={user} username={username} roster={roster} onClose={() => setModalOpen(false)} onSubmit={handleAddBet} />}
                </div>
            );
        }

        function BetModal({ user, username, roster, onClose, onSubmit }) {
            const [participants, setParticipants] = useState([{ name: 'Me', email: user.email, username: username }]); 
            const [winnerEmail, setWinnerEmail] = useState(null);
            const [amount, setAmount] = useState(5);
            const [type, setType] = useState(null);
            const [customType, setCustomType] = useState("");
            const [hole, setHole] = useState(1);
            const [course, setCourse] = useState(localStorage.getItem('lastCourse') || "");

            const presets = [
                { id: "DART", label: "Closest to Pin", img: "./images/bet_cp.png" },
                { id: "HAMMER", label: "Longest Drive", img: "./images/bet_drive.png" },
                { id: "SPLASH", label: "Sand Save", img: "./images/bet_sand.png" },
                { id: "SKIN", label: "Hole Winner", img: "./images/bet_skin.png" },
                { id: "CUSTOM", label: "Manual Entry", img: "./images/bet_custom.png" }
            ];

            useEffect(() => { setTimeout(() => lucide.createIcons(), 100) }, []);

            const toggleParticipant = (friend) => {
                const exists = participants.find(p => p.email === friend.email);
                if (exists) {
                    setParticipants(participants.filter(p => p.email !== friend.email));
                } else {
                    setParticipants([...participants, friend]);
                }
            };

            const handleSubmit = () => {
                const finalType = type.id === 'CUSTOM' ? customType : type.id;
                const finalImg = type.id === 'CUSTOM' ? null : type.img;
                const winnerObj = participants.find(p => p.email === winnerEmail);
                const winnerName = winnerObj ? (winnerObj.email === user.email ? username : winnerObj.username) : 'Unknown';
                const participantEmails = participants.map(p => p.email);

                if(course) localStorage.setItem('lastCourse', course);

                onSubmit({
                    type: finalType,
                    img: finalImg,
                    amount: parseInt(amount),
                    winnerEmail: winnerEmail,
                    winnerName: winnerName,
                    participants: participantEmails,
                    hole: hole,
                    course: course
                });
            };

            return (
                <div className="modal-overlay modal-bottom">
                    <div className="modal-content">
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:20}}>
                            <h3 style={{fontFamily:'Times New Roman', fontSize:24}}>New Wager</h3>
                            <div onClick={onClose} style={{cursor:'pointer'}}><i data-lucide="x"></i></div>
                        </div>

                        <div style={{background:'var(--bg-body)', padding:16, borderRadius:12, marginBottom:24}}>
                            <div className="section-label">LOCATION</div>
                            <div style={{display:'flex', gap:10, alignItems:'center', marginBottom:10}}>
                                <div style={{flex:1}}>
                                    <input className="input-std" style={{width:'100%', fontSize:14}} placeholder="Course Name..." value={course} onChange={(e) => setCourse(e.target.value)} />
                                </div>
                                <div style={{width:60, textAlign:'center'}}>
                                    <div style={{fontSize:10, color:'var(--text-sub)', fontWeight:700}}>HOLE</div>
                                    <div style={{fontSize:24, fontWeight:700, color:'var(--primary)'}}>{hole}</div>
                                </div>
                            </div>
                            <input type="range" min="1" max="18" value={hole} onChange={(e) => setHole(e.target.value)} />
                        </div>

                        <div className="section-label">WHO IS IN THE BET?</div>
                        <div className="chip-grid">
                            <div className={`chip active`}>Me</div>
                            {roster.map(friend => {
                                const isSelected = participants.find(p => p.email === friend.email);
                                return (
                                    <div key={friend.email} className={`chip ${isSelected ? 'active' : ''}`} onClick={() => toggleParticipant(friend)}>
                                        @{friend.username}
                                    </div>
                                );
                            })}
                        </div>

                        {participants.length > 0 && (
                            <>
                                <div className="section-label">WHO WON?</div>
                                <div className="chip-grid">
                                    {participants.map(p => (
                                        <div key={p.email} className={`chip ${winnerEmail === p.email ? 'active-red' : ''}`} onClick={() => setWinnerEmail(p.email)}>
                                            {p.name === 'Me' ? 'Me' : '@'+p.username}
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        <div className="section-label">AMOUNT (PER PERSON)</div>
                        <div className="chip-grid">
                            {[1, 5, 10, 20, 50].map(val => (
                                <div key={val} className={`chip ${amount === val ? 'active' : ''}`} onClick={() => setAmount(val)}>${val}</div>
                            ))}
                        </div>

                        <div className="section-label">BET TYPE</div>
                        <div className="type-grid">
                            {presets.map(p => (
                                <div key={p.id} className={`type-card ${type?.id === p.id ? 'active' : ''}`} onClick={() => setType(p)}>
                                    <img src={p.img} className="type-img" onError={(e) => e.target.style.display='none'} />
                                    <div style={{fontWeight:700, fontSize:14}}>{p.id === 'CUSTOM' ? 'Custom' : p.id}</div>
                                    <div style={{fontSize:11, color:'var(--text-sub)'}}>{p.label}</div>
                                </div>
                            ))}
                        </div>

                        {type?.id === 'CUSTOM' && (
                            <div style={{marginBottom:32}}>
                                <div className="section-label">ENTER BET DETAILS</div>
                                <input className="input-std" style={{width:'100%'}} placeholder="e.g. Hit the green on Par 3" value={customType} onChange={(e) => setCustomType(e.target.value)} />
                            </div>
                        )}

                        <button 
                            className="btn-full btn-primary" 
                            disabled={!winnerEmail || !type || (type.id==='CUSTOM' && !customType) || participants.length < 2} 
                            onClick={handleSubmit}>
                            Place Bet <i data-lucide="check-circle" size="18" style={{marginLeft:8, verticalAlign:'text-bottom'}}></i>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setInterval(() => lucide.createIcons(), 1000); 
    </script>
</body>
</html>