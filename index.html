<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Scratch - The Gentlemen's Wager</title>
    
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" type="image/png" href="./images/logo192.png" />
    <link rel="apple-touch-icon" href="./images/logo192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#00594C">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #00594C; --accent: #E8D55A; --bg-body: #F3F4F6; --bg-card: #FFFFFF;
            --text-main: #111827; --text-sub: #6B7280; --border: #E5E7EB;
            --font-serif: "Times New Roman", Times, serif; 
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body.dark-mode { --primary: #059669; --bg-body: #111827; --bg-card: #1F2937; --text-main: #F9FAFB; --text-sub: #9CA3AF; --border: #374151; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-sans); transition: background 0.3s; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--bg-card); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* HEADER & TABS */
        .header { background-color: var(--primary); padding: 16px 20px; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .brand h1 { font-family: var(--font-serif); font-size: 22px; font-weight: 700; letter-spacing: 0.5px; }
        .nav-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .nav-item { flex: 1; text-align: center; padding: 16px; color: var(--text-sub); font-weight: 600; cursor: pointer; font-size: 14px; position: relative; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }

        /* LEDGER */
        .hero-card { padding: 40px 20px; text-align: center; background: var(--bg-card); border-bottom: 1px solid var(--border); }
        .hero-amount { font-family: var(--font-serif); font-size: 64px; font-weight: 700; line-height: 1; margin-top: 8px; }
        .text-green { color: #059669; } .text-red { color: #DC2626; }
        .content { flex: 1; padding-bottom: 100px; }
        .feed-list { padding: 0 16px; }
        .bet-row { display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .bet-icon { width: 48px; height: 48px; padding: 8px; background: var(--bg-body); border-radius: 12px; margin-right: 16px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .bet-icon img { width: 100%; height: 100%; object-fit: contain; }
        .bet-info { flex: 1; }
        .bet-val { font-family: var(--font-serif); font-size: 18px; font-weight: 700; }

        /* SETTINGS & ROSTER */
        .settings-view { padding: 24px; }
        .settings-card { background: var(--bg-body); border-radius: 12px; border: 1px solid var(--border); padding: 16px; margin-bottom: 24px; }
        .roster-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .roster-item:last-child { border-bottom: none; }
        .delete-btn { color: #DC2626; font-size: 18px; cursor: pointer; padding: 4px; }
        .add-row { display: flex; gap: 8px; margin-top: 12px; }
        .input-std { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: flex-end; z-index: 100; }
        .modal-content { background: var(--bg-card); width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .section-label { font-size: 11px; font-weight: 800; color: var(--text-sub); margin-bottom: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .chip-grid { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .chip { padding: 10px 16px; border: 1px solid var(--border); background: var(--bg-card); border-radius: 50px; font-weight: 600; color: var(--text-main); font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .chip.active-red { background: #DC2626; color: white; border-color: #DC2626; } 
        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 32px; }
        .type-card { border: 1px solid var(--border); padding: 16px; border-radius: 12px; text-align: center; background: var(--bg-card); cursor: pointer; position: relative; }
        .type-card.active { border-color: var(--primary); background: rgba(0, 89, 76, 0.05); box-shadow: 0 0 0 2px var(--primary); }
        .type-img { width: 40px; height: 40px; margin-bottom: 8px; object-fit: contain; opacity: 0.7; }
        .type-card.active .type-img { opacity: 1; }

        /* BUTTONS */
        .fab { position: fixed; bottom: 30px; right: 24px; width: 64px; height: 64px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; text-align: center; border: none; }
        .btn-primary { background: var(--primary); color: white; }

        /* LOGIN & SETUP */
        .login-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .loading-tip { font-size: 12px; opacity: 0.6; margin-top: 20px; color: #DC2626; display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, getDocs, getDoc, setDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
    // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBPBps7eOq5gqyT5LuOnUGJkhPumBbZh-w",
  authDomain: "scratch-d0420.firebaseapp.com",
  projectId: "scratch-d0420",
  storageBucket: "scratch-d0420.firebasestorage.app",
  messagingSenderId: "780358513887",
  appId: "1:780358513887:web:64d2cd2ab8350fb4cda56a"
};

// Initialize Firebase

        const firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(firebaseApp);
        window.auth = getAuth(firebaseApp);
        window.provider = new GoogleAuthProvider();
        window.ops = { collection, addDoc, doc, updateDoc, getDocs, getDoc, setDoc, query, where, orderBy, onSnapshot, serverTimestamp, signInWithPopup, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState(null);
            const [loading, setLoading] = useState(true);
            const [roster, setRoster] = useState([]); // Array of { name, email, username }

            useEffect(() => {
                const timer = setTimeout(() => {
                    const tip = document.getElementById('loading-tip');
                    if(tip) tip.style.display = 'block';
                }, 4000);

                if (!window.ops) return;
                const unsubscribe = window.ops.onAuthStateChanged(window.auth, async (u) => {
                    if (u) {
                        try {
                            const userRef = window.ops.doc(window.db, "users", u.uid);
                            const docSnap = await window.ops.getDoc(userRef);
                            
                            // If user exists and has a username
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.username) {
                                    setUsername(data.username);
                                    if(data.roster) setRoster(data.roster);
                                }
                            } else {
                                // First time login, create basic doc, username will remain null
                                await window.ops.setDoc(userRef, { email: u.email, displayName: u.displayName }, { merge: true });
                            }
                        } catch (e) { console.log("Offline/Block", e); }
                    }
                    setUser(u);
                    setLoading(false);
                    clearTimeout(timer);
                });
                return () => { unsubscribe(); clearTimeout(timer); }
            }, []);

            const handleLogin = async () => {
                try { await window.ops.signInWithPopup(window.auth, window.provider); } catch (e) { alert(e.message); }
            };

            const handleSetUsername = async (newUsername) => {
                const cleanName = newUsername.trim().toLowerCase().replace(/\s+/g, '');
                if (cleanName.length < 3) return alert("Username too short.");
                
                // Check Uniqueness
                const q = window.ops.query(window.ops.collection(window.db, "users"), window.ops.where("username", "==", cleanName));
                const snap = await window.ops.getDocs(q);
                if (!snap.empty) return alert("Username taken! Try another.");

                // Save
                const userRef = window.ops.doc(window.db, "users", user.uid);
                await window.ops.setDoc(userRef, { username: cleanName }, { merge: true });
                setUsername(cleanName);
            };

            const addFriend = async (friendUsername) => {
                const cleanName = friendUsername.trim().toLowerCase().replace('@', '');
                
                // Find User
                const q = window.ops.query(window.ops.collection(window.db, "users"), window.ops.where("username", "==", cleanName));
                const snap = await window.ops.getDocs(q);
                
                if (snap.empty) return alert("User @" + cleanName + " not found.");

                const friendData = snap.docs[0].data();
                if(friendData.email === user.email) return alert("You can't add yourself!");

                // Add to Roster
                const newFriend = { name: friendData.displayName || cleanName, email: friendData.email, username: cleanName };
                // Prevent Duplicates
                if(roster.some(r => r.username === cleanName)) return alert("Already in roster.");

                const newRoster = [...roster, newFriend];
                setRoster(newRoster);
                
                const userRef = window.ops.doc(window.db, "users", user.uid);
                await window.ops.updateDoc(userRef, { roster: newRoster });
            };

            const removeFriend = async (friendEmail) => {
                const newRoster = roster.filter(f => f.email !== friendEmail);
                setRoster(newRoster);
                const userRef = window.ops.doc(window.db, "users", user.uid);
                await window.ops.updateDoc(userRef, { roster: newRoster });
            };

            if (loading) return (
                <div className="login-screen">
                    <div>Loading...</div>
                    <div id="loading-tip" className="loading-tip">Taking a long time? <br/>Disable AdBlocker or try Incognito.</div>
                </div>
            );

            if (!user) {
                return (
                    <div className="login-screen">
                        <img src="./images/logo192.png" style={{width:80, borderRadius:16, marginBottom:20}} onError={(e)=>e.target.style.display='none'}/>
                        <h1 style={{fontFamily:'Times New Roman', fontSize:48}}>Scratch</h1>
                        <p style={{opacity:0.6, letterSpacing:2, fontSize:12, marginBottom:40}}>THE GENTLEMEN'S LEDGER</p>
                        <button className="btn-full" style={{background:'white', color:'var(--primary)', maxWidth:280, boxShadow:'0 10px 30px rgba(0,0,0,0.1)'}} onClick={handleLogin}>
                            Sign in with Google
                        </button>
                    </div>
                );
            }

            // USERNAME SETUP SCREEN
            if (!username) {
                return (
                    <div className="login-screen">
                        <h2 style={{fontFamily:'Times New Roman'}}>Create Username</h2>
                        <p style={{opacity:0.6, fontSize:14, marginBottom:20}}>This is how friends will find you.</p>
                        <input id="usernameInput" className="input-std" placeholder="e.g. Tiger" style={{textAlign:'center', fontSize:20, maxWidth:200, marginBottom:20}} />
                        <button className="btn-full btn-primary" style={{maxWidth:200}} onClick={() => handleSetUsername(document.getElementById('usernameInput').value)}>Set Username</button>
                    </div>
                );
            }

            return <MainApp user={user} username={username} roster={roster} onAddFriend={addFriend} onRemoveFriend={removeFriend} />;
        }

        function MainApp({ user, username, roster, onAddFriend, onRemoveFriend }) {
            const [view, setView] = useState('ledger'); 
            const [bets, setBets] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);

            useEffect(() => {
                const q = window.ops.query(
                    window.ops.collection(window.db, "bets"), 
                    window.ops.where("participants", "array-contains", user.email),
                    window.ops.orderBy("createdAt", "desc")
                );
                
                return window.ops.onSnapshot(q, (snapshot) => {
                    const allBets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBets(allBets);
                });
            }, [user]);

            const stats = useMemo(() => {
                let balance = 0;
                bets.forEach(b => {
                    const numPlayers = b.participants ? b.participants.length : 2;
                    if (b.winnerEmail === user.email) {
                        balance += (b.amount * (numPlayers - 1));
                    } else {
                        balance -= b.amount;
                    }
                });
                return balance;
            }, [bets]);

            const handleAddBet = async (betData) => {
                try {
                    await window.ops.addDoc(window.ops.collection(window.db, "bets"), {
                        ...betData,
                        createdBy: user.uid,
                        createdAt: window.ops.serverTimestamp()
                    });
                    setModalOpen(false);
                } catch (e) { alert(e.message); }
            };

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="brand"><h1>Scratch</h1></div>
                        <div className="icon-btn" onClick={() => setView('settings')}><i data-lucide="settings"></i></div>
                    </header>

                    <div className="nav-tabs">
                        <div className={`nav-item ${view === 'ledger' ? 'active' : ''}`} onClick={() => setView('ledger')}>Ledger</div>
                        <div className={`nav-item ${view === 'settings' ? 'active' : ''}`} onClick={() => setView('settings')}>Settings</div>
                    </div>

                    {view === 'ledger' && (
                        <div className="content">
                            <div className="hero-card">
                                <div style={{fontSize:11, fontWeight:800, color:'var(--text-sub)', textTransform:'uppercase'}}>Net Balance</div>
                                <div className={`hero-amount ${stats >= 0 ? 'text-green' : 'text-red'}`}>
                                    {stats >= 0 ? '+' : '-'}${Math.abs(stats)}
                                </div>
                            </div>
                            <div style={{padding:'24px 20px 10px', fontWeight:700, display:'flex', alignItems:'center', gap:8}}>
                                <i data-lucide="history" size="18"></i> Recent Activity
                            </div>
                            <div className="feed-list">
                                {bets.map(bet => {
                                    const iWon = bet.winnerEmail === user.email;
                                    return (
                                        <div key={bet.id} className="bet-row">
                                            <div className="bet-icon">
                                                {bet.img ? <img src={bet.img} onError={(e)=>{e.target.style.display='none'}} /> : <i data-lucide="trophy" color="var(--primary)" style={{marginTop:6}}></i>}
                                            </div>
                                            <div className="bet-info">
                                                <div style={{fontWeight:600, fontSize:16}}>{bet.type}</div>
                                                <div style={{fontSize:13, color:'var(--text-sub)'}}>
                                                    {iWon ? 'You won' : `${bet.winnerName || 'Opponent'} won`}
                                                </div>
                                            </div>
                                            <div className={`bet-val ${iWon ? 'text-green' : 'text-red'}`}>
                                                {iWon ? '+' : '-'}${bet.amount}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <button className="fab" onClick={() => setModalOpen(true)}><i data-lucide="plus" size="32"></i></button>
                        </div>
                    )}

                    {view === 'settings' && (
                        <div className="settings-view">
                            <div style={{textAlign:'center', marginBottom:30}}>
                                <img src={user.photoURL} style={{width:80, borderRadius:'50%', border:'3px solid var(--primary)'}} />
                                <h2>{user.displayName}</h2>
                                <p style={{fontSize:14, fontWeight:'bold', color:'var(--primary)'}}>@{username}</p>
                            </div>
                            
                            <div className="section-label">MY ROSTER</div>
                            <div className="settings-card">
                                {roster.length === 0 && <div style={{padding:10, color:'#999', fontSize:13}}>No friends added yet.</div>}
                                {roster.map((friend, i) => (
                                    <div key={i} className="roster-item">
                                        <div>
                                            <span style={{fontWeight:600, display:'block'}}>{friend.name}</span>
                                            <span style={{fontSize:12, color:'var(--primary)'}}>@{friend.username}</span>
                                        </div>
                                        <div className="delete-btn" onClick={() => onRemoveFriend(friend.email)}>Ã—</div>
                                    </div>
                                ))}
                                <div className="add-row">
                                    <input id="newFriendUser" className="input-std" placeholder="Search Username..." />
                                    <button className="btn-primary" style={{borderRadius:8, padding:'0 16px', border:'none', cursor:'pointer'}} onClick={() => {
                                        const val = document.getElementById('newFriendUser').value;
                                        if(val) { onAddFriend(val); document.getElementById('newFriendUser').value = ''; }
                                    }}>Add</button>
                                </div>
                            </div>
                            <button className="btn-full" style={{background:'transparent', border:'1px solid #DC2626', color:'#DC2626'}} onClick={() => window.ops.signOut(window.auth)}>Sign Out</button>
                        </div>
                    )}

                    {modalOpen && <BetModal user={user} username={username} roster={roster} onClose={() => setModalOpen(false)} onSubmit={handleAddBet} />}
                </div>
            );
        }

        function BetModal({ user, username, roster, onClose, onSubmit }) {
            // Self is now { name, email, username }
            const [participants, setParticipants] = useState([{ name: 'Me', email: user.email, username: username }]); 
            const [winnerEmail, setWinnerEmail] = useState(null);
            const [amount, setAmount] = useState(5);
            const [type, setType] = useState(null);
            const [customType, setCustomType] = useState("");

            const presets = [
                { id: "DART", label: "Closest to Pin", img: "./images/bet_cp.png" },
                { id: "HAMMER", label: "Longest Drive", img: "./images/bet_drive.png" },
                { id: "SPLASH", label: "Sand Save", img: "./images/bet_sand.png" },
                { id: "SKIN", label: "Hole Winner", img: "./images/bet_skin.png" },
                { id: "CUSTOM", label: "Manual Entry", img: "./images/bet_custom.png" }
            ];

            useEffect(() => { setTimeout(() => lucide.createIcons(), 100) }, []);

            const toggleParticipant = (friend) => {
                const exists = participants.find(p => p.email === friend.email);
                if (exists) {
                    setParticipants(participants.filter(p => p.email !== friend.email));
                } else {
                    setParticipants([...participants, friend]);
                }
            };

            const handleSubmit = () => {
                const finalType = type.id === 'CUSTOM' ? customType : type.id;
                const finalImg = type.id === 'CUSTOM' ? null : type.img;
                
                const winnerObj = participants.find(p => p.email === winnerEmail);
                // If I won, store my username, else store theirs
                const winnerName = winnerObj ? (winnerObj.email === user.email ? username : winnerObj.username) : 'Unknown';

                const participantEmails = participants.map(p => p.email);

                onSubmit({
                    type: finalType,
                    img: finalImg,
                    amount: parseInt(amount),
                    winnerEmail: winnerEmail,
                    winnerName: winnerName,
                    participants: participantEmails
                });
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:20}}>
                            <h3 style={{fontFamily:'Times New Roman', fontSize:24}}>New Wager</h3>
                            <div onClick={onClose} style={{cursor:'pointer'}}><i data-lucide="x"></i></div>
                        </div>

                        <div className="section-label">WHO IS IN THE BET?</div>
                        <div className="chip-grid">
                            <div className={`chip active`}>Me</div>
                            {roster.map(friend => {
                                const isSelected = participants.find(p => p.email === friend.email);
                                return (
                                    <div key={friend.email} 
                                        className={`chip ${isSelected ? 'active' : ''}`}
                                        onClick={() => toggleParticipant(friend)}>
                                        @{friend.username}
                                    </div>
                                );
                            })}
                        </div>

                        {participants.length > 0 && (
                            <>
                                <div className="section-label">WHO WON?</div>
                                <div className="chip-grid">
                                    {participants.map(p => (
                                        <div key={p.email} 
                                            className={`chip ${winnerEmail === p.email ? 'active-red' : ''}`}
                                            onClick={() => setWinnerEmail(p.email)}>
                                            {p.name === 'Me' ? 'Me' : '@'+p.username}
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        <div className="section-label">AMOUNT (PER PERSON)</div>
                        <div className="chip-grid">
                            {[1, 5, 10, 20, 50].map(val => (
                                <div key={val} className={`chip ${amount === val ? 'active' : ''}`} onClick={() => setAmount(val)}>${val}</div>
                            ))}
                        </div>

                        <div className="section-label">BET TYPE</div>
                        <div className="type-grid">
                            {presets.map(p => (
                                <div key={p.id} className={`type-card ${type?.id === p.id ? 'active' : ''}`} onClick={() => setType(p)}>
                                    <img src={p.img} className="type-img" onError={(e) => e.target.style.display='none'} />
                                    <div style={{fontWeight:700, fontSize:14}}>{p.id === 'CUSTOM' ? 'Custom' : p.id}</div>
                                    <div style={{fontSize:11, color:'var(--text-sub)'}}>{p.label}</div>
                                </div>
                            ))}
                        </div>

                        {type?.id === 'CUSTOM' && (
                            <div style={{marginBottom:32}}>
                                <div className="section-label">ENTER BET DETAILS</div>
                                <input className="input-std" style={{width:'100%'}} placeholder="e.g. Hit the green on Par 3" value={customType} onChange={(e) => setCustomType(e.target.value)} />
                            </div>
                        )}

                        <button className="btn-full btn-primary" 
                            disabled={!winnerEmail || !type || (type.id==='CUSTOM' && !customType)} 
                            onClick={handleSubmit}>
                            Place Bet <i data-lucide="check-circle" size="18" style={{marginLeft:8, verticalAlign:'text-bottom'}}></i>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setInterval(() => lucide.createIcons(), 1000); 
    </script>
</body>
</html>